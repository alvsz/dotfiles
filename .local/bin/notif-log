#!/bin/env sh

# notifs='[ ]'
notifs=$(eww get notifs)

# and .hints."desktop-entry" != "org.kde.kdeconnect"

busctl --user monitor org.freedesktop.Notifications -j | jq '. | select(.member == "Notify") | .payload.data |
  { app_name: (.[0]), replaces_id: (.[1]), app_icon: (.[2]), summary: (.[3]), body: (.[4]), actions: (.[5]), hints: (.[6] | to_entries | map( { (.key): (.value.data) } ) | add), expire_timeout: (.[7]) } |
          select(.hints."wired-note" != "osd" )' -c --unbuffered |
	while read -r line; do
		# echo $line
		# (.[6] | to_entries | map( { (.key): (.value.data) } ) )
		# echo done
		line=$(echo "$line" | jq -c --arg time "$(date +%H:%M)" '. + { time: $time }')
		# echo $line
		# notifs=$( eww get notifs )
		notifs=$(eww get notifs | jq -c --argjson line "$line" '. + [$line] | to_entries | map( .value + {id: .key} )')
		eww update notifs="$notifs"
		echo "$notifs" | jq -c
		# 'to_entries | map( .value + {id: .key} )'
	done
